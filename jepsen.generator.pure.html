<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.generator.pure documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.1.17</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-3 current"><a href="jepsen.generator.pure.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pure</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -269px;"><span class="top" style="height: 278px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.generator.pure.html#var-all-processes"><div class="inner"><span>all-processes</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-all-threads"><div class="inner"><span>all-threads</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-any"><div class="inner"><span>any</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-clients"><div class="inner"><span>clients</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-delay-til"><div class="inner"><span>delay-til</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-dissoc-vec"><div class="inner"><span>dissoc-vec</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-each-thread"><div class="inner"><span>each-thread</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-f-map"><div class="inner"><span>f-map</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-filter"><div class="inner"><span>filter</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-free-processes"><div class="inner"><span>free-processes</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-free-threads"><div class="inner"><span>free-threads</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-Generator"><div class="inner"><span>Generator</span></div></a></li><li class="depth-2 branch"><a href="jepsen.generator.pure.html#var-op"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>op</span></div></a></li><li class="depth-2"><a href="jepsen.generator.pure.html#var-update"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>update</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-ignore-updates"><div class="inner"><span>ignore-updates</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-limit"><div class="inner"><span>limit</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-log"><div class="inner"><span>log</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-map"><div class="inner"><span>map</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-mix"><div class="inner"><span>mix</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-nemesis"><div class="inner"><span>nemesis</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-next-process"><div class="inner"><span>next-process</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-on"><div class="inner"><span>on</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-on-threads"><div class="inner"><span>on-threads</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-on-threads-context"><div class="inner"><span>on-threads-context</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-once"><div class="inner"><span>once</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-phases"><div class="inner"><span>phases</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-process-.3Ethread"><div class="inner"><span>process-&gt;thread</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-process-limit"><div class="inner"><span>process-limit</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-random-int-seq"><div class="inner"><span>random-int-seq</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-reserve"><div class="inner"><span>reserve</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-sleep"><div class="inner"><span>sleep</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-soonest-op-vec"><div class="inner"><span>soonest-op-vec</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-stagger"><div class="inner"><span>stagger</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-synchronize"><div class="inner"><span>synchronize</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-then"><div class="inner"><span>then</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-time-limit"><div class="inner"><span>time-limit</span></div></a></li><li class="depth-1"><a href="jepsen.generator.pure.html#var-validate"><div class="inner"><span>validate</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.generator.pure</h1><div class="doc"><div class="markdown"><p>A Jepsen history is a list of operations–invocations and completions. A generator’s job is to specify what invocations to perform, and when. In a sense, a generator <em>becomes</em> a history as Jepsen incrementally applies it to a real system.</p>
<p>Naively, we might define a history as a fixed sequence of invocations to perform at certain times, but this is impossible: we have only a fixed set of threads, and they may not be free to perform our operations. A thread must be <em>free</em> in order to perform an operation.</p>
<p>Time, too, is a dependency. When we schedule an operation to occur once per second, we mean that only once a certain time has passed can the next operation begin.</p>
<p>There may also be dependencies between threads. Perhaps only after a nemesis has initiated a network partition does our client perform a particular read. We want the ability to hold until a certain operation has begun.</p>
<p>Conceptually, then, a generator is a <em>graph</em> of events, some of which have not yet occurred. Some events are invocations: these are the operations the generator will provide to clients. Some events are completions: these are provided by clients to the generator. Other events are temporal: a certain time has passed.</p>
<p>This graph has some invocations which are <em>ready</em> to perform. When we have a ready invocation, we apply the invocation as an input to the graph, obtaining a new graph, and hand the operation to the relevant client.</p>
<h2><a href="#contexts" name="contexts"></a>Contexts</h2>
<p>A <em>context</em> is a map which provides context for generators. For instance, a generator might need to know the number of threads which will ask it for operations. It can get that number from the <em>context</em>. Users can add their own values to the context map, which allows two generators to share state. When one generator calls another, it can pass a modified version of the context, which allows us to write generators that, say, run two independent workloads, each with their own concurrency and thread mappings.</p>
<p>The standard context mappings, which are provided by Jepsen when invoking the top-level generator, and can be expected by every generator, are:</p>
<pre><code>:time           The current Jepsen linear time, in nanoseconds
:free-threads   A collection of idle threads which could perform work
:workers        A map of thread identifiers to process identifiers
</code></pre>
<h2><a href="#fetching-an-operation" name="fetching-an-operation"></a>Fetching an operation</h2>
<p>We use <code>(op gen test context)</code> to ask the generator for the next invocation that we can process.</p>
<p>The operation can have three forms:</p>
<ul>
  <li>The generator may return <code>nil</code>, which means the generator is done, and  there is nothing more to do. Once a generator does this, it must never  return anything other than <code>nil</code>, even if the context changes.</li>
  <li>The generator may return :pending, which means there might be more  ops later, but it can’t tell yet.</li>
  <li>The generator may return an operation, in which case:</li>
  <li>If its time is in the past, we can evaluate it now</li>
  <li>If its time is in the future, we wait until either:
    <ul>
      <li>The time arrives</li>
      <li>Circumstances change (e.g. we update the generator)</li>
    </ul>
  </li>
</ul>
<p>But (op gen test context) returns more than just an operation; it also returns the <em>subsequent state</em> of the generator, if that operation were to be emitted. The two are bundled into a tuple.</p>
<p>(op gen test context) =&gt; [op gen’] ; known op  [:pending gen] ; unsure  nil ; exhausted</p>
<p>The analogous operations for sequences are (first) and (next); why do we couple them here? Why not use the update mechanism strictly to evolve state? Because the behavior in sequences is relatively simple: next always moves forward one item, whereas only <em>some</em> updates actually cause systems to move forward. Seqs always do the same thing in response to <code>next</code>, whereas generators may do different things depending on context. Moreover, Jepsen generators are often branched, rather than linearly wrapped, as sequences are, resulting in questions about <em>which branch</em> needs to be updated.</p>
<p>When I tried to strictly separate implementations of (op) and (update), it resulted in every update call attempting to determine whether this particular generator did or did not emit the given invocation event. This is <em>remarkably</em> tricky to do well, and winds up relying on all kinds of non-local assumptions about the behavior of the generators you wrap, and those which wrap you.</p>
<h2><a href="#updating-a-generator" name="updating-a-generator"></a>Updating a generator</h2>
<p>We still want the ability to respond to invocations and completions, e.g. by tracking that information in context variables. Therefore, in addition to (op) returning a new generator, we have a separate function, (update gen test context event), which allows generators to react to changing circumstances.</p>
<ul>
  <li>We invoke an operation (e.g. one that the generator just gave us)</li>
  <li>We complete an operation</li>
</ul>
<p>Updates use a context with a specific relationship to the event:</p>
<ul>
  <li>The context :time is equal to the event :time</li>
  <li>The free processes and worker maps reflect those <em>prior</em> to the event taking place. This ensures that generators can examine the worker map to identify which thread performed the given operation.</li>
</ul>
<p>TODO: this is not true yet. Fix this.</p>
<h2><a href="#default-implementations" name="default-implementations"></a>Default implementations</h2>
<p>Nil is a valid generator; it ignores updates and always yields nil for operations.</p>
<p>IPersistentMaps are generators which ignore updates and return operations which look like the map itself, but with default values for time, process, and type provided based on the context. This means you can write a generator like</p>
<p>{:f :write, :value 2}</p>
<p>and it will generate ops like</p>
<p>{:type :invoke, :process 3, :time 1234, :f :write, :value 2}</p>
<p>Sequences are generators which assume the elements of the sequence are themselves generators. They ignore updates, and return all operations from the first generator in the sequence, then all operations from the second, and so on. They do not synchronize.</p>
<p>Functions are generators which ignore updates and can take either test and context as arguments, or no args. Functions should be <em>mostly</em> pure, but some creative impurity is probably OK. For instance, returning randomized :values for maps is probably all right. I don’t know the laws! What is this, Haskell?</p>
<p>Functions can return two things:</p>
<ul>
  <li>nil: signifies that the function generator is exhausted.</li>
  <li>a tuple of [op gen]: passed through directly; the gen replaces the fn</li>
  <li>a map: the map is treated as a generator, which lets it fill in a process,  time, etc.</li>
</ul>
<p>In the future, we might consider:</p>
<ul>
  <li>Returning any other generator: the function could be <em>replaced</em> by that generator, allowing us to compute generators lazily?</li>
</ul></div></div><div class="public anchor" id="var-all-processes"><h3>all-processes</h3><div class="usage"><code>(all-processes context)</code></div><div class="doc"><div class="markdown"><p>Given a context, returns all processes currently being executed by threads.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L176">view source</a></div></div><div class="public anchor" id="var-all-threads"><h3>all-threads</h3><div class="usage"><code>(all-threads context)</code></div><div class="doc"><div class="markdown"><p>Given a context, returns a collection of all threads.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L187">view source</a></div></div><div class="public anchor" id="var-any"><h3>any</h3><div class="usage"><code>(any &amp; gens)</code></div><div class="doc"><div class="markdown"><p>Takes multiple generators and binds them together. Operations are taken from any generator. Updates are propagated to all generators.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L449">view source</a></div></div><div class="public anchor" id="var-clients"><h3>clients</h3><div class="usage"><code>(clients client-gen)</code><code>(clients client-gen nemesis-gen)</code></div><div class="doc"><div class="markdown"><p>In the single-arity form, wraps a generator such that only clients request operations from it. In its two-arity form, combines a generator of client operations and a generator for nemesis operations into one. When the process requesting an operation is :nemesis, routes to the nemesis generator; otherwise to the client generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L587">view source</a></div></div><div class="public anchor" id="var-delay-til"><h3>delay-til</h3><div class="usage"><code>(delay-til dt gen)</code></div><div class="doc"><div class="markdown"><p>Given a time dt in seconds, and an underlying generator gen, constructs a generator which aligns invocations to intervals of dt seconds.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L797">view source</a></div></div><div class="public anchor" id="var-dissoc-vec"><h3>dissoc-vec</h3><div class="usage"><code>(dissoc-vec v i)</code></div><div class="doc"><div class="markdown"><p>Cut a single index out of a vector, returning a vector one shorter, without the element at that index.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L611">view source</a></div></div><div class="public anchor" id="var-each-thread"><h3>each-thread</h3><div class="usage"><code>(each-thread gen)</code></div><div class="doc"><div class="markdown"><p>Takes a generator. Constructs a generator which maintains independent copies of that generator for every thread. Each generator sees exactly one thread in its free process list. Updates are propagated to the generator for the thread which emitted the operation.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L500">view source</a></div></div><div class="public anchor" id="var-f-map"><h3>f-map</h3><div class="usage"><code>(f-map f-map g)</code></div><div class="doc"><div class="markdown"><p>Takes a function <code>f-map</code> converting op functions (:f op) to other functions, and a generator <code>g</code>. Returns a generator like <code>g</code>, but where fs are replaced according to <code>f-map</code>. Useful for composing generators together for use with a composed nemesis.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L320">view source</a></div></div><div class="public anchor" id="var-filter"><h3>filter</h3><div class="usage"><code>(filter f gen)</code></div><div class="doc"><div class="markdown"><p>A generator which filters operations from an underlying generator, passing on only those which match (f op). Like <code>map</code>, :pending and nil operations bypass the filter.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L343">view source</a></div></div><div class="public anchor" id="var-free-processes"><h3>free-processes</h3><div class="usage"><code>(free-processes context)</code></div><div class="doc"><div class="markdown"><p>Given a context, returns a collection of processes which are not actively processing invocations.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L170">view source</a></div></div><div class="public anchor" id="var-free-threads"><h3>free-threads</h3><div class="usage"><code>(free-threads context)</code></div><div class="doc"><div class="markdown"><p>Given a context, returns a collection of threads that are not actively processing invocations.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L181">view source</a></div></div><div class="public anchor" id="var-Generator"><h3>Generator</h3><h4 class="type">protocol</h4><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="members"><h4>members</h4><div class="inner"><div class="public anchor" id="var-op"><h3>op</h3><div class="usage"><code>(op gen test context)</code></div><div class="doc"><div class="markdown"></div></div></div><div class="public anchor" id="var-update"><h3>update</h3><div class="usage"><code>(update gen test context event)</code></div><div class="doc"><div class="markdown"><p>Updates the generator to reflect an event having taken place</p></div></div></div></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L154">view source</a></div></div><div class="public anchor" id="var-ignore-updates"><h3>ignore-updates</h3><div class="usage"><code>(ignore-updates gen)</code></div><div class="doc"><div class="markdown"><p>Wraps a generator. Any call to <code>update</code> is ignored, returning this generator with no changes.</p>
<p>It’s not clear if this actually confers any performance advantage right now.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L359">view source</a></div></div><div class="public anchor" id="var-limit"><h3>limit</h3><div class="usage"><code>(limit remaining gen)</code></div><div class="doc"><div class="markdown"><p>Wraps a generator and ensures that it returns at most <code>limit</code> operations. Propagates every update to the underlying generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L657">view source</a></div></div><div class="public anchor" id="var-log"><h3>log</h3><div class="usage"><code>(log msg)</code></div><div class="doc"><div class="markdown"><p>A generator which, when asked for an operation, logs a message and yields nil.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L376">view source</a></div></div><div class="public anchor" id="var-map"><h3>map</h3><div class="usage"><code>(map f gen)</code></div><div class="doc"><div class="markdown"><p>A generator which wraps another generator g, transforming operations it generates with (f op test process), of if that fails, (f op). When the underlying generator yields :pending or nil, this generator does too, without calling <code>f</code>. Passes updates to underlying generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L312">view source</a></div></div><div class="public anchor" id="var-mix"><h3>mix</h3><div class="usage"><code>(mix gens)</code></div><div class="doc"><div class="markdown"><p>A random mixture of several generators. Takes a collection of generators and chooses between them uniformly. Ignores updates; some users create broad (hundreds of generators) mixes.</p>
<p>To be precise, a mix behaves like a sequence of one-time, randomly selected generators from the given collection. This is efficient and prevents multiple generators from competing for the next slot, making it hard to control the mixture of operations.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L634">view source</a></div></div><div class="public anchor" id="var-nemesis"><h3>nemesis</h3><div class="usage"><code>(nemesis nemesis-gen)</code><code>(nemesis nemesis-gen client-gen)</code></div><div class="doc"><div class="markdown"><p>In the single-arity form, wraps a generator such that only the nemesis requests operations from it. In its two-arity form, combines a generator of client operations and a generator for nemesis operations into one. When the process requesting an operation is :nemesis, routes to the nemesis generator; otherwise to the client generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L599">view source</a></div></div><div class="public anchor" id="var-next-process"><h3>next-process</h3><div class="usage"><code>(next-process context thread)</code></div><div class="doc"><div class="markdown"><p>When a process being executed by a thread crashes, this function returns the next process for a given thread. You should probably only use this with the <em>global</em> context, because it relies on the size of the <code>:workers</code> map.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L200">view source</a></div></div><div class="public anchor" id="var-on"><h3>on</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L414">view source</a></div></div><div class="public anchor" id="var-on-threads"><h3>on-threads</h3><div class="usage"><code>(on-threads f gen)</code></div><div class="doc"><div class="markdown"><p>Wraps a generator, restricting threads which can use it to only those threads which satisfy (f thread). Alters the context passed to the underlying generator: it will only include free threads and workers satisfying f. Updates are passed on only when the thread performing the update matches f.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L406">view source</a></div></div><div class="public anchor" id="var-on-threads-context"><h3>on-threads-context</h3><div class="usage"><code>(on-threads-context f ctx)</code></div><div class="doc"><div class="markdown"><p>Helper function to transform contexts for OnThreads. Takes a function which returns true if a thread should be included in the context.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L382">view source</a></div></div><div class="public anchor" id="var-once"><h3>once</h3><div class="usage"><code>(once gen)</code></div><div class="doc"><div class="markdown"><p>Emits only a single item from the underlying generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L663">view source</a></div></div><div class="public anchor" id="var-phases"><h3>phases</h3><div class="usage"><code>(phases &amp; generators)</code></div><div class="doc"><div class="markdown"><p>Takes several generators, and constructs a generator which evaluates everything from the first generator, then everything from the second, and so on.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L839">view source</a></div></div><div class="public anchor" id="var-process-.3Ethread"><h3>process-&gt;thread</h3><div class="usage"><code>(process-&gt;thread context process)</code></div><div class="doc"><div class="markdown"><p>Takes a context and a process, and returns the thread which is executing that process.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L192">view source</a></div></div><div class="public anchor" id="var-process-limit"><h3>process-limit</h3><div class="usage"><code>(process-limit n gen)</code></div><div class="doc"><div class="markdown"><p>Takes a generator and returns a generator with bounded concurrency–it emits operations for up to n distinct processes, but no more.</p>
<p>Specifically, we track the set of all processes in a context’s <code>workers</code> map: the underlying generator can return operations only from contexts such that the union of all processes across all such contexts has cardinality at most <code>n</code>. Tracking the union of all <em>possible</em> processes, rather than just those processes actually performing operations, prevents the generator from “trickling” at the end of a test, i.e. letting only one or two processes continue to perform ops, rather than the full concurrency of the test.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L682">view source</a></div></div><div class="public anchor" id="var-random-int-seq"><h3>random-int-seq</h3><div class="usage"><code>(random-int-seq)</code><code>(random-int-seq seed)</code></div><div class="doc"><div class="markdown"><p>Generates a reproducible sequence of random longs, given a random seed. If seed is not provided, taken from (rand-int)).</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L162">view source</a></div></div><div class="public anchor" id="var-reserve"><h3>reserve</h3><div class="usage"><code>(reserve &amp; args)</code></div><div class="doc"><div class="markdown"><p>Takes a series of count, generator pairs, and a final default generator.</p>
<p>(reserve 5 write 10 cas read)</p>
<p>The first 5 threads will call the <code>write</code> generator, the next 10 will emit CAS operations, and the remaining threads will perform reads. This is particularly useful when you want to ensure that two classes of operations have a chance to proceed concurrently–for instance, if writes begin blocking, you might like reads to proceed concurrently without every thread getting tied up in a write.</p>
<p>Each generator sees a context which only includes the worker threads which will execute that particular generator. Updates from a thread are propagated only to the generator which that thread executes.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L550">view source</a></div></div><div class="public anchor" id="var-sleep"><h3>sleep</h3><div class="usage"><code>(sleep)</code></div><div class="doc"><div class="markdown"><p>Informally, pauses for dt seconds before yielding <code>nil</code> for an operation. Formally, this is sort of a weird one, because everything here is pure, and there’s no notion of blocking. We can delay operations, which have times, but delaying <em>nil</em>, which does NOT have a time, isn’t straightforward.</p>
<p>What we’ll need to do, later, is invent a special type of operation map which delays the scheduler and is <em>not</em> passed to clients. Or just refuse to implement this at all. It’s nicely readable, but it’s semantically kind of weird (Who sleeps? When?) compared to delaying a subsequent operation, which has a well defined behavior.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L803">view source</a></div></div><div class="public anchor" id="var-soonest-op-vec"><h3>soonest-op-vec</h3><div class="usage"><code>(soonest-op-vec pair1 pair2)</code></div><div class="doc"><div class="markdown"><p>Takes two [op, …] vectors, and returns the vector whose op occurs first. Op maps occur before those which are :pending. :pending occurs before <code>nil</code>.</p>
<p>We use vectors here because you may want to pass [op, gen’] pairs, or possibly encode additional information into the vector, so you can, for instance, identify <em>which</em> of several generators was the next one.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L416">view source</a></div></div><div class="public anchor" id="var-stagger"><h3>stagger</h3><div class="usage"><code>(stagger dt gen)</code></div><div class="doc"><div class="markdown"><p>Wraps a generator. Operations from that generator are delayed by a uniform random time between 0 to 2 * dt.</p>
<p>Note that unlike jepsen’s original version of <code>stagger</code>, this delay applies to <em>all</em> operations, not to each thread independently. If your old stagger dt is 10, and your concurrency is 5, your new stagger dt should be 2.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L726">view source</a></div></div><div class="public anchor" id="var-synchronize"><h3>synchronize</h3><div class="usage"><code>(synchronize gen)</code></div><div class="doc"><div class="markdown"><p>Takes a generator, and waits for all workers to be free before it begins.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L834">view source</a></div></div><div class="public anchor" id="var-then"><h3>then</h3><div class="usage"><code>(then a b)</code></div><div class="doc"><div class="markdown"><p>Generator A, synchronize, then generator B. Note that this takes its arguments backwards: b comes before a. Why? Because it reads better in -&gt;&gt; composition. You can say:</p>
<pre><code>(-&gt;&gt; (fn [] {:f :write :value 2})
     (limit 3)
     (then (once {:f :read})))
</code></pre></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L846">view source</a></div></div><div class="public anchor" id="var-time-limit"><h3>time-limit</h3><div class="usage"><code>(time-limit dt gen)</code></div><div class="doc"><div class="markdown"><p>Takes a time in seconds, and an underlying generator. Once this emits an operation (taken from that underlying generator), will only emit operations for dt seconds.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L707">view source</a></div></div><div class="public anchor" id="var-validate"><h3>validate</h3><div class="usage"><code>(validate gen)</code></div><div class="doc"><div class="markdown"><p>Validates the well-formedness of operations emitted from the underlying generator.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/generator/pure.clj#L295">view source</a></div></div></div></body></html>