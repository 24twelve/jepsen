<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>jepsen.tests.cycle.append documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Jepsen</span> <span class="project-version">0.1.17</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>jepsen</span></div></div></li><li class="depth-2 branch"><a href="jepsen.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-2"><a href="jepsen.checker.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>checker</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.clock.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>clock</span></div></a></li><li class="depth-3 branch"><a href="jepsen.checker.perf.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>perf</span></div></a></li><li class="depth-3"><a href="jepsen.checker.timeline.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>timeline</span></div></a></li><li class="depth-2 branch"><a href="jepsen.cli.html"><div class="inner"><span class="tree" style="top: -114px;"><span class="top" style="height: 123px;"></span><span class="bottom"></span></span><span>cli</span></div></a></li><li class="depth-2 branch"><a href="jepsen.client.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>client</span></div></a></li><li class="depth-2 branch"><a href="jepsen.codec.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>codec</span></div></a></li><li class="depth-2"><a href="jepsen.control.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>control</span></div></a></li><li class="depth-3 branch"><a href="jepsen.control.net.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.control.util.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2 branch"><a href="jepsen.core.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2 branch"><a href="jepsen.db.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>db</span></div></a></li><li class="depth-2 branch"><a href="jepsen.faketime.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>faketime</span></div></a></li><li class="depth-2"><a href="jepsen.generator.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>generator</span></div></a></li><li class="depth-3"><a href="jepsen.generator.pure.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>pure</span></div></a></li><li class="depth-2 branch"><a href="jepsen.independent.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>independent</span></div></a></li><li class="depth-2"><a href="jepsen.nemesis.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>nemesis</span></div></a></li><li class="depth-3 branch"><a href="jepsen.nemesis.combined.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>combined</span></div></a></li><li class="depth-3"><a href="jepsen.nemesis.time.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>time</span></div></a></li><li class="depth-2"><a href="jepsen.net.html"><div class="inner"><span class="tree" style="top: -83px;"><span class="top" style="height: 92px;"></span><span class="bottom"></span></span><span>net</span></div></a></li><li class="depth-3"><a href="jepsen.net.proto.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>proto</span></div></a></li><li class="depth-2"><a href="jepsen.os.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>os</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.centos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>centos</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.debian.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>debian</span></div></a></li><li class="depth-3 branch"><a href="jepsen.os.smartos.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>smartos</span></div></a></li><li class="depth-3"><a href="jepsen.os.ubuntu.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>ubuntu</span></div></a></li><li class="depth-2 branch"><a href="jepsen.reconnect.html"><div class="inner"><span class="tree" style="top: -145px;"><span class="top" style="height: 154px;"></span><span class="bottom"></span></span><span>reconnect</span></div></a></li><li class="depth-2 branch"><a href="jepsen.repl.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>repl</span></div></a></li><li class="depth-2 branch"><a href="jepsen.report.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>report</span></div></a></li><li class="depth-2 branch"><a href="jepsen.store.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>store</span></div></a></li><li class="depth-2"><a href="jepsen.tests.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>tests</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.adya.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>adya</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.bank.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>bank</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.causal-reverse.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>causal-reverse</span></div></a></li><li class="depth-3"><a href="jepsen.tests.cycle.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>cycle</span></div></a></li><li class="depth-4 current"><a href="jepsen.tests.cycle.append.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>append</span></div></a></li><li class="depth-3 branch"><a href="jepsen.tests.linearizable-register.html"><div class="inner"><span class="tree" style="top: -52px;"><span class="top" style="height: 61px;"></span><span class="bottom"></span></span><span>linearizable-register</span></div></a></li><li class="depth-3"><a href="jepsen.tests.long-fork.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>long-fork</span></div></a></li><li class="depth-2 branch"><a href="jepsen.util.html"><div class="inner"><span class="tree" style="top: -269px;"><span class="top" style="height: 278px;"></span><span class="bottom"></span></span><span>util</span></div></a></li><li class="depth-2"><a href="jepsen.web.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>web</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-append-index"><div class="inner"><span>append-index</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-append-txns"><div class="inner"><span>append-txns</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-checker"><div class="inner"><span>checker</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-cycle-explainer"><div class="inner"><span>cycle-explainer</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-cycle-explanations"><div class="inner"><span>cycle-explanations</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-cycles"><div class="inner"><span>cycles</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-duplicates"><div class="inner"><span>duplicates</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-expand-anomalies"><div class="inner"><span>expand-anomalies</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g-single-cases"><div class="inner"><span>g-single-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g0-cases"><div class="inner"><span>g0-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g1a-cases"><div class="inner"><span>g1a-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g1b-cases"><div class="inner"><span>g1b-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g1c-cases"><div class="inner"><span>g1c-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g1c-graph"><div class="inner"><span>g1c-graph</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-g2-cases"><div class="inner"><span>g2-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-gen"><div class="inner"><span>gen</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-graph"><div class="inner"><span>graph</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-incompatible-orders"><div class="inner"><span>incompatible-orders</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-internal-cases"><div class="inner"><span>internal-cases</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-merge-orders"><div class="inner"><span>merge-orders</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-mop-deps"><div class="inner"><span>mop-deps</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-op-deps"><div class="inner"><span>op-deps</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-op-internal-case"><div class="inner"><span>op-internal-case</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-op-mops"><div class="inner"><span>op-mops</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-prefix.3F"><div class="inner"><span>prefix?</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-preprocess"><div class="inner"><span>preprocess</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-previously-appended-element"><div class="inner"><span>previously-appended-element</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-read-index"><div class="inner"><span>read-index</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-rw-graph"><div class="inner"><span>rw-graph</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-rw-mop-deps"><div class="inner"><span>rw-mop-deps</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-sorted-values"><div class="inner"><span>sorted-values</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-test"><div class="inner"><span>test</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-unknown-prefix"><div class="inner"><span>unknown-prefix</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-values-from-single-appends"><div class="inner"><span>values-from-single-appends</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-verify-mop-types"><div class="inner"><span>verify-mop-types</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-verify-total-order"><div class="inner"><span>verify-total-order</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-verify-unique-appends"><div class="inner"><span>verify-unique-appends</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-wr-graph"><div class="inner"><span>wr-graph</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-wr-mop-dep"><div class="inner"><span>wr-mop-dep</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-wr-txns"><div class="inner"><span>wr-txns</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-write-index"><div class="inner"><span>write-index</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-ww-graph"><div class="inner"><span>ww-graph</span></div></a></li><li class="depth-1"><a href="jepsen.tests.cycle.append.html#var-ww-mop-dep"><div class="inner"><span>ww-mop-dep</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">jepsen.tests.cycle.append</h1><div class="doc"><div class="markdown"><p>Detects cycles in histories where operations are transactions over named lists lists, and operations are either appends or reads. Used with jepsen.tests.cycle.</p></div></div><div class="public anchor" id="var-append-index"><h3>append-index</h3><div class="usage"><code>(append-index sorted-values)</code></div><div class="doc"><div class="markdown"><p>Takes a map of keys to observed values (e.g. from sorted-values), and builds a bidirectional index: a map of keys to indexes on those keys, where each index is a map relating appended values on that key to the order in which they were effectively appended by the database.</p>
<p>{:x {:indices {v0 0, v1 1, v2 2}  :values [v0 v1 v2]}}</p>
<p>We merge all observed orders on a key using merge-orders.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L383">view source</a></div></div><div class="public anchor" id="var-append-txns"><h3>append-txns</h3><div class="usage"><code>(append-txns opts)</code></div><div class="doc"><div class="markdown"><p>Like wr-txns, we just rewrite writes to be appends.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L985">view source</a></div></div><div class="public anchor" id="var-checker"><h3>checker</h3><div class="usage"><code>(checker)</code><code>(checker opts)</code></div><div class="doc"><div class="markdown"><p>Full checker for append and read histories. Options are:</p>
<p>:additional-graphs A collection of graph analyzers (e.g. realtime)  which should be merged with our own dependencies.  :anomalies A collection of anomalies which should be reported,  if found.</p>
<p>Supported anomalies are:</p>
<p>:G0 Write Cycle. A cycle comprised purely of write-write deps.  :G1a Aborted Read. A transaction observes data from a failed txn.  :G1b Intermediate Read. A transaction observes a value from the middle of  another transaction.  :G1c Circular Information Flow. A cycle comprised of write-write and  write-read edges.  :G1 G1a, G1b, and G1c.  :G2 A dependency cycle with at least one anti-dependency edge.</p>
<p>:G2 implies :G1c, and :G1c implies :G0, because if we construct the graph for G2, it’ll include all the edges for G1c, and so on. See <a href="http://pmg.csail.mit.edu/papers/icde00.pdf">http://pmg.csail.mit.edu/papers/icde00.pdf</a> for context.</p>
<p>Note that while we can <em>find</em> instances of G0, G1c and G2, we can’t (yet) categorize them automatically. These anomalies are grouped under :G0+G1c+G2 in checker results.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L882">view source</a></div></div><div class="public anchor" id="var-cycle-explainer"><h3>cycle-explainer</h3><div class="usage"></div><div class="doc"><div class="markdown"></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L702">view source</a></div></div><div class="public anchor" id="var-cycle-explanations"><h3>cycle-explanations</h3><div class="usage"><code>(cycle-explanations pair-explainer cycle-fn sccs)</code></div><div class="doc"><div class="markdown"><p>Takes a pair explainer, a function taking an scc and possible yielding a cycle, and a series of strongly connected components. Produces a seq (nil if empty) of explanations of cycles.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L729">view source</a></div></div><div class="public anchor" id="var-cycles"><h3>cycles</h3><div class="usage"><code>(cycles opts test history checker-opts)</code></div><div class="doc"><div class="markdown"><p>Performs dependency graph analysis and returns a sequence of anomalies.</p>
<p>Options:</p>
<p>:additional-graphs A collection of graph analyzers (e.g. realtime)  which should be merged with our own dependencies.  :anomalies A collection of anomalies which should be reported,  if found.</p>
<p>Supported anomalies are :G0, :G1c, :G-single, and :G2. G2 implies G-single and G1c, and G1c implies G0.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L828">view source</a></div></div><div class="public anchor" id="var-duplicates"><h3>duplicates</h3><div class="usage"><code>(duplicates history)</code></div><div class="doc"><div class="markdown"><p>Given a history, finds operations which have duplicate copies of the same appended element. Since we only append values once, we should never see them more than that–and if we do, it could mess up our whole “total order” thing!</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L315">view source</a></div></div><div class="public anchor" id="var-expand-anomalies"><h3>expand-anomalies</h3><div class="usage"><code>(expand-anomalies as)</code></div><div class="doc"><div class="markdown"><p>Takes a collection of anomalies, and returns the fully expanded version of those anomalies as a set: e.g. [:G1] -&gt; #{:G0 :G1a :G1b :G1c}</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L818">view source</a></div></div><div class="public anchor" id="var-g-single-cases"><h3>g-single-cases</h3><div class="usage"><code>(g-single-cases graph pair-explainer sccs)</code></div><div class="doc"><div class="markdown"><p>Given a graph, an explainer, and a collection of strongly connected components, searches for instances of G-single anomalies within them. Returns nil if none are present.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L771">view source</a></div></div><div class="public anchor" id="var-g0-cases"><h3>g0-cases</h3><div class="usage"><code>(g0-cases graph pair-explainer sccs)</code></div><div class="doc"><div class="markdown"><p>Given a graph, a pair explainer, and a collection of strongly connected components, searches for instances of G0 anomalies within it. Returns nil if none are present.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L742">view source</a></div></div><div class="public anchor" id="var-g1a-cases"><h3>g1a-cases</h3><div class="usage"><code>(g1a-cases history)</code></div><div class="doc"><div class="markdown"><p>G1a, or aborted read, is an anomaly where a transaction reads data from an aborted transaction. For us, an aborted transaction is one that we know failed. Info transactions may abort, but if they do, the only way for us to TELL they aborted is by observing their writes, and if we observe their writes, we can’t conclude they aborted, sooooo…</p>
<p>This function takes a history (which should include :fail events!), and produces a sequence of error objects, each representing an operation which read state written by a failed transaction.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L67">view source</a></div></div><div class="public anchor" id="var-g1b-cases"><h3>g1b-cases</h3><div class="usage"><code>(g1b-cases history)</code></div><div class="doc"><div class="markdown"><p>G1b, or intermediate read, is an anomaly where a transaction T2 reads a state for key k that was written by another transaction, T1, that was not T1’s final update to k.</p>
<p>This function takes a history (which should include :fail events!), and produces a sequence of error objects, each representing a read of an intermediate state.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L101">view source</a></div></div><div class="public anchor" id="var-g1c-cases"><h3>g1c-cases</h3><div class="usage"><code>(g1c-cases graph pair-explainer sccs)</code></div><div class="doc"><div class="markdown"><p>Given a graph, an explainer, and a collection of strongly connected components, searches for instances of G1c anomalies within them. Returns nil if none are present.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L755">view source</a></div></div><div class="public anchor" id="var-g1c-graph"><h3>g1c-graph</h3><div class="usage"><code>(g1c-graph history)</code></div><div class="doc"><div class="markdown"><p>Per Adya, Liskov, &amp; O’Neil, phenomenon G1C encompasses any cycle made up of direct dependency edges (but does not include anti-dependencies).</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L654">view source</a></div></div><div class="public anchor" id="var-g2-cases"><h3>g2-cases</h3><div class="usage"><code>(g2-cases graph pair-explainer sccs)</code></div><div class="doc"><div class="markdown"><p>Given a graph, an explainer, and a collection of strongly connected components, searches for instances of G2 anomalies within them. Returns nil if none are present.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L788">view source</a></div></div><div class="public anchor" id="var-gen"><h3>gen</h3><div class="usage"><code>(gen)</code><code>(gen opts)</code></div><div class="doc"><div class="markdown"><p>A generator for operations where values are transactions made up of reads  and appends to various integer keys. Takes options:</p>
<p>:key-count Number of distinct keys at any point  :min-txn-length Minimum number of operations per txn  :max-txn-length Maximum number of operations per txn  :max-writes-per-key Maximum number of operations per key</p>
<p>For defaults, see wr-txns.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L991">view source</a></div></div><div class="public anchor" id="var-graph"><h3>graph</h3><div class="usage"><code>(graph history)</code></div><div class="doc"><div class="markdown"><p>Some parts of a transaction’s dependency graph–for instance, anti-dependency cycles–involve the <em>version order</em> of states for a key. Given two transactions: <a href="null">:w :x 1</a> and <a href="null">:w :x 2</a>, we can’t tell whether T1 or T2 happened first. This makes it hard to identify read-write and write-write edges, because we can’t tell what particular transaction should have overwritten the state observed by a previous transaction.</p>
<p>However, if we constrain ourselves to transactions whose only mutation is to <em>append</em> a value to a key’s current state…</p>
<p>{:f :txn, :value <a href="null">:r :x [1 2</a> [:append :x 3] [:r :x [1 2 3]]]} …</p>
<p>… we can derive the version order for (almost) any pair of operations on the same key because the order of appends is encoded in every read: if we observe [:r :x [3 1 2]], we know the previous states must have been [3] [3 1] [3 1 2].</p>
<p>That is, assuming appends actually work correctly. If the database loses appends or reorders them, it’s <em>likely</em> (but not necessarily the case), that we’ll observe states like:</p>
<p>[1 2 3]
  [1 3 4] ; 2 has been lost!</p>
<p>We can verify these in a single O(appends^2) pass by sorting all observed states for a key by size, and verifying that each is a prefix of the next. Assuming we <em>do</em> observe a total order, we can use the longest read value for each key as an order over appends for that key. This order is <em>almost</em> complete in that appends which are never read can’t be related, but so long as the DB lets us see most of our appends at least once, this should work.</p>
<p>So then, our strategy here is to compute those orders for each key, then use them to relate successive [w w], [r w], and [w r] pair on that key. [w,w] pairs are a direct write dependency, [w,r] pairs are a direct read-dependency, and [r,w] pairs are direct anti-dependencies.</p>
<p>For more context, see Adya, Liskov, and O’Neil’s ‘Generalized Isolation Level Definitions’, page 8.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L660">view source</a></div></div><div class="public anchor" id="var-incompatible-orders"><h3>incompatible-orders</h3><div class="usage"><code>(incompatible-orders sorted-values)</code></div><div class="doc"><div class="markdown"><p>Takes a map of keys to sorted observed values and verifies that for each key the values read are consistent with a total order of appends. For instance, these values are consistent:</p>
<p>{:x <a href="null">1] [1 2 3</a>}</p>
<p>But these two are not:</p>
<p>{:x <a href="null">1 2] [1 3 2</a>}</p>
<p>… because the first is not a prefix of the second. Returns a sequence of anomaly maps, nil if none are present.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L263">view source</a></div></div><div class="public anchor" id="var-internal-cases"><h3>internal-cases</h3><div class="usage"><code>(internal-cases history)</code></div><div class="doc"><div class="markdown"><p>Given a history, finds operations which exhibit internal consistency violations: e.g. some read [:r k v] in the transaction fails to observe a v consistent with that transaction’s previous append operations, including whatever (initially unknown) state k began with.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L188">view source</a></div></div><div class="public anchor" id="var-merge-orders"><h3>merge-orders</h3><div class="usage"><code>(merge-orders as bs)</code><code>(merge-orders merged as bs)</code></div><div class="doc"><div class="markdown"><p>Takes two potentially incompatible read orders (sequences of elements), and computes a total order which is consistent with both of them: where there are conflicts, we drop those elements.</p>
<p>First, we remove duplicates; an order shouldn’t have them at all. Yes, this means we fail to compute some dependencies.</p>
<p>In general, the differences between orders fall into some cases:</p>
<ol>
  <li>One empty
    <p>_ 1 2 3 4 5</p>
  </li>
</ol>
<p>We simply pick the non-empty order.</p>
<ol>
  <li>Same first element</li>
</ol>
<p>2 x y  2 z</p>
<p>Our order is [2] followed by the merged result of [x y] and [z].</p>
<ol>
  <li>Different first elements followed by a common element</li>
</ol>
<p>3 y  2 3</p>
<p>We drop the smaller element and recur with [3 y] [3]. This isn’t… exactly symmetric; we prefer longer and higher elements for tail-end conflicts, but I think that’s still a justifiable choice. After all, we DID read both values, and it’s sensible to compute a dependency based on any read. Might as well pick longer ones.</p>
<p>Later, we should change the whole structure of append indexes to admit multiple prior txns rather than just one, and get rid of this.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L334">view source</a></div></div><div class="public anchor" id="var-mop-deps"><h3>mop-deps</h3><div class="usage"><code>(mop-deps append-index write-index read-index op [f :as mop])</code></div><div class="doc"><div class="markdown"><p>A set of dependencies for a mop in an op.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L485">view source</a></div></div><div class="public anchor" id="var-op-deps"><h3>op-deps</h3><div class="usage"><code>(op-deps append-index write-index read-index op)</code></div><div class="doc"><div class="markdown"><p>All dependencies for an op.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L497">view source</a></div></div><div class="public anchor" id="var-op-internal-case"><h3>op-internal-case</h3><div class="usage"><code>(op-internal-case op)</code></div><div class="doc"><div class="markdown"><p>Given an op, returns a map describing internal consistency violations, or nil otherwise. Our maps are:</p>
<pre><code>{:op        The operation which went wrong
 :mop       The micro-operation which went wrong
 :expected  The state we expected to observe. Either a definite list
            like [1 2 3] or a postfix like ['... 3]}
</code></pre></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L152">view source</a></div></div><div class="public anchor" id="var-op-mops"><h3>op-mops</h3><div class="usage"><code>(op-mops history)</code></div><div class="doc"><div class="markdown"><p>A lazy sequence of all [op mop] pairs from a history.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L29">view source</a></div></div><div class="public anchor" id="var-prefix.3F"><h3>prefix?</h3><div class="usage"><code>(prefix? a b)</code></div><div class="doc"><div class="markdown"><p>Given two sequences, returns true iff A is a prefix of B.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L199">view source</a></div></div><div class="public anchor" id="var-preprocess"><h3>preprocess</h3><div class="usage"><code>(preprocess history)</code></div><div class="doc"><div class="markdown"><p>Before we do any graph computation, we need to preprocess the history, making sure it’s well-formed. We return a map of:</p>
<p>{:history The history restricted to :ok and :info ops  :append-index An append index  :write-index A write index  :read-index A read index}</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L504">view source</a></div></div><div class="public anchor" id="var-previously-appended-element"><h3>previously-appended-element</h3><div class="usage"><code>(previously-appended-element append-index write-index op [f k v])</code></div><div class="doc"><div class="markdown"><p>Given an append mop, finds the element that was appended immediately prior to this append. Returns ::init if this was the first append.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L447">view source</a></div></div><div class="public anchor" id="var-read-index"><h3>read-index</h3><div class="usage"><code>(read-index history)</code></div><div class="doc"><div class="markdown"><p>Takes a history restricted to oks and infos, and constructs a map of keys to append values to the operations which observed the state generated by the append of k. The special append value ::init generates the initial (nil) state.</p>
<p>Note that reads of <code>nil</code> by :info ops don’t result in an entry in this index, because those <code>nil</code>s denote the default read value, NOT that we actually observed <code>nil</code>.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L416">view source</a></div></div><div class="public anchor" id="var-rw-graph"><h3>rw-graph</h3><div class="usage"><code>(rw-graph history)</code></div><div class="doc"><div class="markdown"><p>Analyzes read-write anti-dependencies.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L636">view source</a></div></div><div class="public anchor" id="var-rw-mop-deps"><h3>rw-mop-deps</h3><div class="usage"><code>(rw-mop-deps append-index write-index read-index op [f k v :as mop])</code></div><div class="doc"><div class="markdown"><p>The set of (other) operations which read the value just before this write mop.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L472">view source</a></div></div><div class="public anchor" id="var-sorted-values"><h3>sorted-values</h3><div class="usage"><code>(sorted-values history)</code></div><div class="doc"><div class="markdown"><p>Takes a history where operation values are transactions, and every micro-op in a transaction is an append or a read. Computes a map of keys to all distinct observed values for that key, ordered by length.</p>
<p>As a special case, if we have a key which only has a single append, we don’t need a read: we can infer the sorted values it took on were simply [], [x].</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L233">view source</a></div></div><div class="public anchor" id="var-test"><h3>test</h3><div class="usage"><code>(test opts)</code></div><div class="doc"><div class="markdown"><p>A partial test, including a generator and checker. You’ll need to provide a client which can understand operations of the form:</p>
<pre><code>{:type :invoke, :f :txn, :value [[:r 3 nil] [:append 3 2] [:r 3]]}
</code></pre>
<p>and return completions like:</p>
<pre><code>{:type :invoke, :f :txn, :value [[:r 3 [1]] [:append 3 2] [:r 3 [1 2]]]}
</code></pre>
<p>where the key 3 identifies some list, whose value is initially [1], and becomes [1 2].</p>
<p>Options are:</p>
<pre><code>:key-count            Number of distinct keys at any point
:min-txn-length       Minimum number of operations per txn
:max-txn-length       Maximum number of operations per txn
:max-writes-per-key   Maximum number of operations per key
:anomalies            A list (e.g. [:G-single]) of anomalies to check for
:additional-graphs    A list of functions constructing graphs over txns
                      (e.g. [cycle/realtime-graph])
</code></pre>
<p>For defaults, see wr-txns.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L1008">view source</a></div></div><div class="public anchor" id="var-unknown-prefix"><h3>unknown-prefix</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>A marker we use in a list to identify an unknown prefix.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L148">view source</a></div></div><div class="public anchor" id="var-values-from-single-appends"><h3>values-from-single-appends</h3><div class="usage"><code>(values-from-single-appends history)</code></div><div class="doc"><div class="markdown"><p>As a special case of sorted-values, if we have a key which only has a single append, we don’t need a read: we can infer the sorted values it took on were simply [], [x].</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L209">view source</a></div></div><div class="public anchor" id="var-verify-mop-types"><h3>verify-mop-types</h3><div class="usage"><code>(verify-mop-types history)</code></div><div class="doc"><div class="markdown"><p>Takes a history where operation values are transactions. Verifies that the history contains only reads [:r k v] and appends [:append k v]. Returns nil if the history conforms, or throws an error object otherwise.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L34">view source</a></div></div><div class="public anchor" id="var-verify-total-order"><h3>verify-total-order</h3><div class="usage"><code>(verify-total-order sorted-values)</code></div><div class="doc"><div class="markdown"><p>Takes a map of keys to observed values (e.g. from <code>sorted-values</code>, and verifies that for each key, the values read are consistent with a total order of appends. For instance, these values are consistent:</p>
<p>{:x <a href="null">1] [1 2 3</a>}</p>
<p>But these two are not:</p>
<p>{:x <a href="null">1 2] [1 3 2</a>}</p>
<p>… because the first is not a prefix of the second.</p>
<p>Returns nil if the history is OK, or throws otherwise.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L293">view source</a></div></div><div class="public anchor" id="var-verify-unique-appends"><h3>verify-unique-appends</h3><div class="usage"><code>(verify-unique-appends history)</code></div><div class="doc"><div class="markdown"><p>Takes a history of txns made up of appends and reads, and checks to make sure that every invoke appending a value to a key chose a unique value.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L46">view source</a></div></div><div class="public anchor" id="var-wr-graph"><h3>wr-graph</h3><div class="usage"><code>(wr-graph history)</code></div><div class="doc"><div class="markdown"><p>Analyzes write-read dependencies.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L591">view source</a></div></div><div class="public anchor" id="var-wr-mop-dep"><h3>wr-mop-dep</h3><div class="usage"><code>(wr-mop-dep write-index op [f k v])</code></div><div class="doc"><div class="markdown"><p>What (other) operation wrote the value just before this read mop?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L436">view source</a></div></div><div class="public anchor" id="var-wr-txns"><h3>wr-txns</h3><div class="usage"><code>(wr-txns opts)</code><code>(wr-txns opts state)</code></div><div class="doc"><div class="markdown"><p>A lazy sequence of write and read transactions over a pool of n numeric keys; every write is unique per key. Options:</p>
<p>:key-count Number of distinct keys at any point  :min-txn-length Minimum number of operations per txn  :max-txn-length Maximum number of operations per txn  :max-writes-per-key Maximum number of operations per key</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L939">view source</a></div></div><div class="public anchor" id="var-write-index"><h3>write-index</h3><div class="usage"><code>(write-index history)</code></div><div class="doc"><div class="markdown"><p>Takes a history restricted to oks and infos, and constructs a map of keys to append values to the operations that appended those values.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L402">view source</a></div></div><div class="public anchor" id="var-ww-graph"><h3>ww-graph</h3><div class="usage"><code>(ww-graph history)</code></div><div class="doc"><div class="markdown"><p>Analyzes write-write dependencies.</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L554">view source</a></div></div><div class="public anchor" id="var-ww-mop-dep"><h3>ww-mop-dep</h3><div class="usage"><code>(ww-mop-dep append-index write-index op [f k v :as mop])</code></div><div class="doc"><div class="markdown"><p>What (other) operation wrote the value just before this write mop?</p></div></div><div class="src-link"><a href="https://github.com/jepsen-io/jepsen/blob/0.1.17/jepsen/src/jepsen/tests/cycle/append.clj#L459">view source</a></div></div></div></body></html>